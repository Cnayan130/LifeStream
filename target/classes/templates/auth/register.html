<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
>
<head>
    <title>注册 - LifeStream</title>
</head>

<body>

<th:block layout:fragment="content">
    <div class="auth-container">
        <div class="card auth-card">
            <div class="card-body p-4 p-lg-5">
                <div class="text-center auth-logo">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h3 class="text-center mb-4 fw-light">创建新账号</h3>

                <form th:action="@{/register}" th:object="${userDto}" method="post" id="registerForm" novalidate>

                    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger" role="alert">
                        <ul class="mb-0">
                            <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
                        </ul>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="username" placeholder="用户名"
                               th:field="*{username}" required minlength="3" maxlength="40"
                               th:classappend="${#fields.hasErrors('username')} ? 'is-invalid' : ''">
                        <label for="username">用户名</label>
                        <div class="invalid-feedback" id="username-feedback"
                             th:if="${#fields.hasErrors('username')}" th:errors="*{username}">
                        </div>
                        <div class="form-text">用户名长度为3-40个字符</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="email" placeholder="name@example.com"
                               th:field="*{email}" required
                               th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''">
                        <label for="email">电子邮箱</label>
                        <div class="invalid-feedback" id="email-feedback"
                             th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
                        </div>
                    </div>

                    <div class="form-floating mb-3 position-relative">
                        <input type="password" class="form-control" id="password" placeholder="密码"
                               th:field="*{password}" required minlength="6" maxlength="20"
                               th:classappend="${#fields.hasErrors('password')} ? 'is-invalid' : ''">
                        <label for="password">密码</label>
                        <span class="password-toggle" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </span>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}">
                        </div>
                        <div class="form-text">密码长度为6-20个字符</div>
                    </div>

                    <div class="form-floating mb-3 position-relative">
                        <input type="password" class="form-control" id="confirmPassword" placeholder="确认密码"
                               name="confirmPassword" required minlength="6" maxlength="20"
                               th:classappend="${#fields.hasErrors('confirmPassword')} ? 'is-invalid' : ''">
                        <label for="confirmPassword">确认密码</label>
                        <span class="password-toggle" id="toggleConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </span>
                        <div class="invalid-feedback" id="password-match-feedback">两次输入的密码不一致</div>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}">
                        </div>
                    </div>

                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" id="agreeTerms" th:field="*{agreeTerms}" required
                               th:classappend="${#fields.hasErrors('agreeTerms')} ? 'is-invalid' : ''">
                        <label class="form-check-label" for="agreeTerms">
                            我已阅读并同意 <a th:href="@{/terms}" target="_blank">服务条款</a> 和 <a th:href="@{/privacy}" target="_blank">隐私政策</a>
                        </label>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('agreeTerms')}" th:errors="*{agreeTerms}">
                            您必须同意条款才能注册
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">立即注册</button>
                    </div>
                </form>

                <div class="mt-4 text-center">
                    <p class="mb-0 text-muted">已有账号? <a th:href="@{/login}" class="text-decoration-none fw-bold">返回登录</a></p>
                </div>
            </div>
        </div>
    </div>
</th:block>


<th:block layout:fragment="scripts">
    <script>
        // 确保 DOM 加载完成后再执行脚本
        $(document).ready(function() {

            // 封装一个函数来处理 AJAX 验证
            function checkAvailability(inputElement, feedbackElement, url, paramName) {
                let value = inputElement.val();
                let params = {};
                params[paramName] = value;

                $.get(url, params, function(response) {
                    if (!response.available) {
                        inputElement.addClass('is-invalid');
                        feedbackElement.text(response.message || '该值已被占用');
                        feedbackElement.show(); // 确保反馈可见
                    } else {
                        // 仅当没有服务端错误时才移除 is-invalid
                        if (!inputElement.next('.invalid-feedback[th\\:errors]').length) {
                            inputElement.removeClass('is-invalid');
                        }
                    }
                }).fail(function() {
                    console.error("Availability check failed for: " + paramName);
                });
            }

            // ... (所有其他的 JS 逻辑都保持不变, 它们是正确的) ...

            // 用户名实时验证
            $('#username').on('blur', function() {
                let username = $(this).val();
                if (username.length >= 3) {
                    checkAvailability($(this), $('#username-feedback'), '/api/user/checkUsernameAvailability', 'username');
                }
            });

            // 邮箱实时验证
            $('#email').on('blur', function() {
                let email = $(this).val();
                if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    checkAvailability($(this), $('#email-feedback'), '/api/user/checkEmailAvailability', 'email');
                }
            });

            // 实现密码显示/隐藏功能
            function togglePasswordVisibility(inputElement, toggleIcon) {
                const type = inputElement.attr('type') === 'password' ? 'text' : 'password';
                inputElement.attr('type', type);
                toggleIcon.find('i').toggleClass('fa-eye fa-eye-slash');
            }

            $('#togglePassword').click(function() {
                togglePasswordVisibility($('#password'), $(this));
            });

            $('#toggleConfirmPassword').click(function() {
                togglePasswordVisibility($('#confirmPassword'), $(this));
            });

            // 密码匹配验证 (客户端)
            const password = $('#password');
            const confirmPassword = $('#confirmPassword');
            const matchFeedback = $('#password-match-feedback');

            function validatePasswordMatch() {
                if (password.val() && confirmPassword.val() && password.val() !== confirmPassword.val()) {
                    confirmPassword.addClass('is-invalid');
                    matchFeedback.show();
                    return false;
                } else {
                    if (!confirmPassword.next('.invalid-feedback[th\\:errors]').length) {
                        confirmPassword.removeClass('is-invalid');
                    }
                    matchFeedback.hide();
                    return true;
                }
            }

            confirmPassword.on('input', validatePasswordMatch);
            password.on('input', validatePasswordMatch);

            // 表单提交时的最终客户端验证
            $('#registerForm').on('submit', function(e) {
                let isValid = true;

                if (!validatePasswordMatch()) {
                    isValid = false;
                }

                if ($('#username').hasClass('is-invalid') || $('#email').hasClass('is-invalid')) {
                    isValid = false;
                }

                if (!$('#agreeTerms').is(':checked')) {
                    $('#agreeTerms').addClass('is-invalid');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                }

                $(this).addClass('was-validated');
            });

            // 移除服务端错误样式当用户开始输入时
            $('.form-control[th\\:field]').on('input', function() {
                if ($(this).hasClass('is-invalid')) {
                    $(this).removeClass('is-invalid');
                    $(this).siblings('.invalid-feedback[th\\:errors]').hide();
                }
            });
            $('#agreeTerms').on('change', function() {
                if ($(this).is(':checked')) {
                    $(this).removeClass('is-invalid');
                }
            });

        });
    </script>
</th:block>

</body>
</html>